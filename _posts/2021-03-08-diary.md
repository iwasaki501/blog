---
layout: post
title: 2021-03-08
date: 2021-03-08 16:26
category: diary
---

来月から住む家の情報が届いたけど、明らかなはずれではなかったみたいで安堵。これなら割と本も置けるかな。

# Technology
ネットワークの本が終盤に近付いてきたが、3 日後には忘れてそうな感じがするので今のうちに要点をまとめておこう。

#### ネットワーク上に送信されるデータのイメージ
- イーサネットヘッダ: 送信元・送信先 MAC アドレスが入っている (同じネットワーク内でスイッチがデータを転送するためのもの)
- IP ヘッダ: 送信元・送信先 IP アドレスが入っている。インターネット層との関連。
- TCP ヘッダ: 送信元・送信先ポート番号が入っている。トランスポート層との関連。
- HTTP ヘッダ、HTML ファイル

#### 同じネットワーク上にデータを送信する場合
以下、送り主を MAC アドレス A (IP: 192.168.1.1, スイッチのポート 1)、送り先を MAC アドレス B (IP: 192.168.1.2, スイッチのポート 2) とする。送り先については IP アドレスのみが既知。
1. PC に保存されている、送り先の IP アドレスとその MAC アドレスの対応表 (Address Resolution Protocol; ARP) を確認。表に 192.168.1.2 がない場合は ARP リクエストをブロードキャストして、該当する IP アドレスの PC が返してきた ARP リプライに基づいてその MAC アドレス (B) を取得。
2. 送り先 MAC アドレス (B) を指定してスイッチにデータを送る。スイッチの MAC アドレステーブル (スイッチのポートと MAC アドレスの対応表) に B がある場合はそのポートへ送ればいいが、そうでない場合はフラッディング (ブロードキャスト) して全体に送る。

#### 異なるネットワーク上にデータを送信する場合
以下、送り主を MAC アドレス A (IP: 192.168.1.1, スイッチのポート 1)、送り先を IP: 202.191.113.152 とする。送り先については IP アドレスのみが既知。
1. 送り先がプライベートアドレスでないので、とりあえずルータにデータを転送する必要がある。上の 1 と同様だが、デフォルトゲートウェイについて ARP を確認し、なければデフォルトゲートウェイの IP アドレスについて ARP リクエストを送信。このようにしてルータの MAC アドレスを取得する。
2. 上の 2 と同様に、ルータへデータを送る。
3. ルータの NAT (Network Address Translation) で、プライベート IP をグローバル IP に変換する。
4. (この辺のどこかで、DNS による名前解決が行われる。)

#### データの送り方
- ネクストホップの決め方。ルータのルーティングテーブルに送り先 IP アドレスがあれば、ネクストホップの IP アドレスへデータを送ればよい。PC のルーティングテーブルにない場合はデフォルトルートが、ルータに行ってもルーティングテーブルにない場合は ISP のルータがネクストホップとなる。この際、IP ヘッダは最初から不変で、イーサネットヘッダが書き換わっていくだけらしい ([これ](https://www.n-study.com/iprouting/routing-behavior/) を参照)
- TCP コネクション (アプリケーション間で確実にデータ転送できること) を確認し、ウィンドウサイズに合わせて分割しながらデータを送信。
