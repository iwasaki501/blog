<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="コンピュータシステムの理論と実装 (10)" /><meta property="og:locale" content="en" /><meta name="description" content="前章までで中間コードをアセンブリに変換する部分は完成したので、本章からは後半部分である Jack 言語から中間コードへのコンパイラを書いていく。" /><meta property="og:description" content="前章までで中間コードをアセンブリに変換する部分は完成したので、本章からは後半部分である Jack 言語から中間コードへのコンパイラを書いていく。" /><link rel="canonical" href="https://ternbusty.github.io/posts/nand2tetris-10.html" /><meta property="og:url" content="https://ternbusty.github.io/posts/nand2tetris-10.html" /><meta property="og:site_name" content="ternbusty" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-15T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="コンピュータシステムの理論と実装 (10)" /><meta name="twitter:site" content="@ternbusty" /> <script type="application/ld+json"> {"headline":"コンピュータシステムの理論と実装 (10)","dateModified":"2022-01-15T00:00:00+09:00","datePublished":"2022-01-15T00:00:00+09:00","description":"前章までで中間コードをアセンブリに変換する部分は完成したので、本章からは後半部分である Jack 言語から中間コードへのコンパイラを書いていく。","url":"https://ternbusty.github.io/posts/nand2tetris-10.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ternbusty.github.io/posts/nand2tetris-10.html"},"@context":"https://schema.org"}</script><title>コンピュータシステムの理論と実装 (10) | ternbusty</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ternbusty"><meta name="application-name" content="ternbusty"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ternbusty</a></div><div class="site-subtitle font-italic">miscellaneous notes</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tools.html" class="nav-link"> <i class="fa-fw fas fa-toolbox ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives.html" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about.html" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ternbusty" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ternbusty" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ternbusty.dev','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>コンピュータシステムの理論と実装 (10)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>コンピュータシステムの理論と実装 (10)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ternbusty">ternbusty</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-01-15 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 15, 2022, 12:00 AM +0900" >Jan 15, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3053 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p>前章までで中間コードをアセンブリに変換する部分は完成したので、本章からは後半部分である Jack 言語から中間コードへのコンパイラを書いていく。</p><h2 id="10-章-コンパイラ1-構文解析">10 章 コンパイラ#1: 構文解析<a href="#10-章-コンパイラ1-構文解析" class='anchor'><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="tokenizer-を書く">tokenizer を書く<a href="#tokenizer-を書く" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>コードを token ごとに区切り、xml として出力するコードを書けばよい。こんなん半角スペースで分割してそれぞれの要素が何であるかを判定していけばいいだけやんとか思っていたが、よく考えたらこれは誤り (<code class="language-plaintext highlighter-rouge">"Hello world"</code> は半角スペースを含むが一つの token であるし、<code class="language-plaintext highlighter-rouge">a[0]</code> は半角スペースを含まないが複数の token を含んでいる)。なので、行ごとに一文字ずつ走査していき、</p><ul><li><code class="language-plaintext highlighter-rouge">"</code> が発見されたら終わりが見つかるまで idx を進め、見つかったら <code class="language-plaintext highlighter-rouge">STRING_CONST</code> として token に加える<li>symbol や半角文字が見つかったらある token の終わりとみなし、まだ出力されていない文字列を token として出力</ul><p>という操作が必要になる。</p><div file="tokenizer.py" class="language-python highlighter-rouge"><div class="code-header"> <span label-text="tokenizer.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tokenDic</span>


<span class="k">class</span> <span class="nc">TokenObject</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">token_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">before</span><span class="p">:</span> <span class="s">'list[str]'</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">after</span><span class="p">:</span> <span class="s">'list[str]'</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">substitute_symbol_dic</span><span class="p">:</span> <span class="nb">str</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'&lt;'</span><span class="p">:</span> <span class="s">'&amp;lt;'</span><span class="p">,</span> <span class="s">'&gt;'</span><span class="p">:</span> <span class="s">'&amp;gt;'</span><span class="p">,</span> <span class="s">'&amp;'</span><span class="p">:</span> <span class="s">'&amp;amp;'</span><span class="p">}</span>
        <span class="n">temp_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token</span> <span class="ow">in</span> <span class="n">substitute_symbol_dic</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">temp_token</span> <span class="o">=</span> <span class="n">substitute_symbol_dic</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">token</span><span class="p">]</span>
        <span class="n">substitute_type_dic</span><span class="p">:</span> <span class="nb">str</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'string_const'</span><span class="p">:</span> <span class="s">'stringConstant'</span><span class="p">,</span> <span class="s">'int_const'</span><span class="p">:</span> <span class="s">'integerConstant'</span><span class="p">}</span>
        <span class="n">temp_token_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_type</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">temp_token_type</span> <span class="ow">in</span> <span class="n">substitute_type_dic</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">temp_token_type</span> <span class="o">=</span> <span class="n">substitute_type_dic</span><span class="p">[</span><span class="n">temp_token_type</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'&lt;</span><span class="si">{</span><span class="n">temp_token_type</span><span class="si">}</span><span class="s">&gt; </span><span class="si">{</span><span class="n">temp_token</span><span class="si">}</span><span class="s"> &lt;/</span><span class="si">{</span><span class="n">temp_token_type</span><span class="si">}</span><span class="s">&gt;'</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">before</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">before</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="n">output</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">after</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">after</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>


<span class="k">class</span> <span class="nc">JackTokenizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span> <span class="o">=</span> <span class="n">p_file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">'(//.*\n|/\*.(.|\s)*?\*/)'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># delete comments
</span>        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">' *\n'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># delete spaces at the end of lines
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">lines</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s">'^\s*$'</span><span class="p">,</span> <span class="n">line</span><span class="p">)]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">line_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'&lt;tokens&gt;</span><span class="se">\n</span><span class="s">'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TokenObject</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">tokenizeLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'list[TokenObject]'</span><span class="p">:</span>
        <span class="n">token_objects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TokenObject</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>
        <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>
        <span class="n">len_of_list</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">beg_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">len_of_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s">'"'</span><span class="p">:</span>
                <span class="n">beg_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">len_of_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s">'"'</span><span class="p">:</span>
                        <span class="n">token_objects</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenObject</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">beg_idx</span><span class="p">:</span><span class="n">idx</span><span class="p">],</span> <span class="s">'STRING_CONST'</span><span class="p">))</span>
                        <span class="n">beg_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tokenDic</span><span class="p">.</span><span class="n">symbols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">beg_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">beg_idx</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">token_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">tokenType</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="n">token_objects</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenObject</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token_type</span><span class="p">))</span>
                <span class="n">token_objects</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenObject</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s">'SYMBOL'</span><span class="p">))</span>
                <span class="n">beg_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s">' '</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">beg_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">beg_idx</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">token_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">tokenType</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="n">token_objects</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenObject</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token_type</span><span class="p">))</span>
                <span class="n">beg_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">token_objects</span>

    <span class="k">def</span> <span class="nf">tokenType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        Determine the type of a given token
        """</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokenDic</span><span class="p">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'KEYWORD'</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokenDic</span><span class="p">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'SYMBOL'</span>
        <span class="k">elif</span> <span class="n">token</span><span class="p">.</span><span class="n">isdecimal</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">32767</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">'INT_CONST'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">SyntaxError</span><span class="p">(</span><span class="s">'Value more than 32767 is not accepted'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">isdecimal</span><span class="p">():</span>
                <span class="nb">SyntaxError</span><span class="p">(</span><span class="s">'Identifier starts with a number is not accepted'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">'IDENTIFIER'</span>

    <span class="k">def</span> <span class="nf">hasMoreLine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">line_num</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span><span class="p">)</span>
        <span class="n">line</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span><span class="p">]</span>
        <span class="n">token_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">tokenizeLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">token_object</span><span class="p">.</span><span class="nb">format</span><span class="p">()</span> <span class="k">for</span> <span class="n">token_object</span> <span class="ow">in</span> <span class="n">token_objects</span><span class="p">])</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token_objects</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">saveToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">+=</span> <span class="s">'&lt;/tokens&gt;</span><span class="se">\n</span><span class="s">'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">path_w</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">parent</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">stem</span><span class="si">}</span><span class="s">T.xml'</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">p_file_list</span><span class="p">:</span> <span class="s">'list[pathlib.Path]'</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">p_path</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">p_file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p_path</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'**/*.jack'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_path</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">p_file</span> <span class="ow">in</span> <span class="n">p_file_list</span><span class="p">:</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">JackTokenizer</span><span class="p">(</span><span class="n">p_file</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">hasMoreLine</span><span class="p">():</span>
            <span class="n">tokenizer</span><span class="p">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="n">tokenizer</span><span class="p">.</span><span class="n">saveToFile</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="構文解析">構文解析<a href="#構文解析" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>構文木を構築するため、再帰下降構文解析を行う (この言葉かっこよくて好きだ)。最初のトークンだけからトークンの種類を決定することができる文法を LL(1) といい、Jack 言語は概ねこれに従っている。例えば他の言語だと返り値無しの関数実行は <code class="language-plaintext highlighter-rouge">a.run()</code> とかになるが、Jack では <code class="language-plaintext highlighter-rouge">do a.run()</code> などと明示することによって、先読みすることなくこれが SubroutineCall であることが分かるようになっている。</p><p>パーサを作るにあたっての留意点は括弧の処理である。例えば while 文 <code class="language-plaintext highlighter-rouge">'while' '(' expression ')' '{' statements '}'</code> という形で表されるが、expression や statements の中にも当然括弧が入りうるので、対応するものを正しく見つける必要がある。今回は、0 で初期化した変数を用意し、文字列を先頭から走査しつつ ( を見つけたら +1、) を見つけたら -1 していき、変数が 0 になったところを閉じ括弧とみなす方法を採用した。AtCoder の茶 diff くらいにありそうな問題だ。</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">findClosingBracket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">open_c</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">close_c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">bracket_cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="n">open_c</span><span class="p">:</span>
            <span class="n">bracket_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="n">close_c</span><span class="p">:</span>
            <span class="n">bracket_cnt</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bracket_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idx</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></table></code></div></div><p>基本的に p233-234 の仕様通りに書いていけばよいが、expression (式) の扱いでやや混乱した。expression は <code class="language-plaintext highlighter-rouge">term (op term)*</code> という形で表され、要は term が op を介して組み合わさっているという形 (具体的には、<code class="language-plaintext highlighter-rouge">1 + 1</code> とか <code class="language-plaintext highlighter-rouge">sum + a[0] + f(3)</code> とか) なので、オペレータを見つけ次第 term として分割し、そのあとの文字列を再帰で処理することになる。</p><p>全体的にゴリゴリの再帰を書くことになり結構疲れた。なんやかんやできたので達成感はある。</p><div file="compiler.py" class="language-python highlighter-rouge"><div class="code-header"> <span label-text="compiler.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tokenizer</span> <span class="kn">import</span> <span class="n">TokenObject</span><span class="p">,</span> <span class="n">JackTokenizer</span>


<span class="k">class</span> <span class="nc">CompilationEngine</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_objects</span><span class="p">:</span> <span class="s">'list[TokenObject]'</span><span class="p">,</span> <span class="n">p_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span> <span class="o">=</span> <span class="n">token_objects</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span> <span class="o">=</span> <span class="n">p_file</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">statement_keyword_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'let'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileLet</span><span class="p">,</span>
            <span class="s">'if'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileIf</span><span class="p">,</span>
            <span class="s">'while'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileWhile</span><span class="p">,</span>
            <span class="s">'do'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileDo</span><span class="p">,</span>
            <span class="s">'return'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileReturn</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="s">''</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileClasses</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileClasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_script</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="s">"""
        Compile classes (whole script) recursively
        """</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end_script</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">closing_class_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileClass</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_script</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_class_idx</span><span class="p">].</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileClasses</span><span class="p">(</span><span class="n">closing_class_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_script</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_script</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="s">"""
        'class' className '{' classVarDec* subroutineDec* '}'
        ex) class Bar {...}
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;class&gt;'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span><span class="p">)</span>
        <span class="n">closing_class_body_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end_script</span><span class="p">,</span> <span class="s">'{'</span><span class="p">,</span> <span class="s">'}'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileClassBody</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">closing_class_body_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_class_body_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/class&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">closing_class_body_idx</span>

    <span class="k">def</span> <span class="nf">compileClassBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="s">"""
        classVarDec* subroutineDec*
        'static int a; method int hoge (...) {...}'
        """</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end_class_body</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">first_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">token</span>
        <span class="k">if</span> <span class="n">first_token</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'static'</span><span class="p">,</span> <span class="s">'field'</span><span class="p">]:</span>
            <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileClassVarDec</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineDec</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileClassBody</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileClassVarDec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        ('static' | 'field') type varName (',' varName) * ';'
        ex) 'static int a;'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;classVarDec&gt;'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_class_body</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">';'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/classVarDec&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">compileSubroutineDec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        ('constructor' | 'function' | 'method') ('void' | type) subroutineName '(' parameterList ')' '{' subroutineBody '}'
        ex) 'method int hoge (...) {...}'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;subroutineDec&gt;'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># compile '(' parameterList ')'
</span>        <span class="n">closing_param_list_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileParameterList</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">closing_param_list_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># compile '{' subroutineBody '}'
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_param_list_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;subroutineBody&gt;'</span><span class="p">)</span>
        <span class="n">closing_subr_body_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">closing_param_list_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_class_body</span><span class="p">,</span> <span class="s">'{'</span><span class="p">,</span> <span class="s">'}'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_subr_body_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/subroutineBody&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineBody</span><span class="p">(</span><span class="n">closing_param_list_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_subr_body_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_subr_body_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/subroutineDec&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">closing_subr_body_idx</span>

    <span class="k">def</span> <span class="nf">compileSubroutineBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_body</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        varDec* statements
        ex) 'var int a; let a = 1; return a;'
        """</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end_body</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">first_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">token</span>
        <span class="k">if</span> <span class="n">first_token</span> <span class="o">==</span> <span class="s">'var'</span><span class="p">:</span>
            <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileVarDec</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_body</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineBody</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;statements&gt;'</span><span class="p">)</span>
            <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileStatements</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_body</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">end_body</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/statements&gt;'</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">compileSubroutineCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        subroutineName '(' expressionList ')' |
        (className | varName) '.' subroutineName '(' expressionList ')'
        ex) 'run()', 'a.run()'
        """</span>
        <span class="c1"># self.token_objects[start].before.append('&lt;term&gt;')
</span>        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">!=</span> <span class="s">'('</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;expressionList&gt;'</span><span class="p">)</span>
        <span class="n">closing_expression_list</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileExpressionList</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">closing_expression_list</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_expression_list</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/expressionList&gt;'</span><span class="p">)</span>
        <span class="c1"># self.token_objects[end].after.append('&lt;/term&gt;')
</span>
    <span class="k">def</span> <span class="nf">compileExpressionList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        (expression (',' expression)*)?
        ex) '(a + 1, b)'
        """</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">exp_start_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">','</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">exp_start_idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">exp_start_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">exp_start_idx</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileParameterList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="s">"""
        ((type varName) (',' type varName)*)?
        ex) 'int a, char c', ''
        """</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">end</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;parameterList&gt;'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/parameterList&gt;'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;parameterList&gt;'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">end</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/parameterList&gt;'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileVarDec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_body</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'var' type varName (',' varname)* ';'
        ex) 'int a, b;';
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;varDec&gt;'</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_body</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">';'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/varDec&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">compileStatements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end_statements</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">first_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">token</span>
        <span class="n">end_statement</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">statement_keyword_dic</span><span class="p">[</span><span class="n">first_token</span><span class="p">](</span><span class="n">start</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileStatements</span><span class="p">(</span><span class="n">end_statement</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileDo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'do' subroutineCall ';'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;doStatement&gt;'</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_statements</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">';'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/doStatement&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineCall</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">compileLet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'let' varname ('[' expression ']')? '=' expression ';'
        ex) 'let a = 5;', 'let a[4] = b + 3;'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;letStatement&gt;'</span><span class="p">)</span>
        <span class="n">right_operand_start_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">'['</span><span class="p">:</span>  <span class="c1"># if '[' expression ']'
</span>            <span class="n">closing_expression_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'['</span><span class="p">,</span> <span class="s">']'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">closing_expression_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">right_operand_start_idx</span> <span class="o">=</span> <span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right_operand_start_idx</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">right_operand_start_idx</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_statements</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">';'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/letStatement&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">right_operand_start_idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">compileWhile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'while' '(' expression ')' '{' statements '}'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;whileStatement&gt;'</span><span class="p">)</span>
        <span class="c1"># (expression)
</span>        <span class="n">closing_expression_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_expression_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># {statements}
</span>        <span class="n">closing_statements_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'{'</span><span class="p">,</span> <span class="s">'}'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;statements&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileStatements</span><span class="p">(</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/statements&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/whileStatement&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">closing_statements_idx</span>

    <span class="k">def</span> <span class="nf">compileReturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'return' expression? ';'
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;returnStatement&gt;'</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_statements</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">';'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/returnStatement&gt;'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">findClosingBracket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">open_c</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">close_c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">bracket_cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="n">open_c</span><span class="p">:</span>
                <span class="n">bracket_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="n">close_c</span><span class="p">:</span>
                <span class="n">bracket_cnt</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">bracket_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">idx</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'not found'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileIf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        'if' '(' expression ')' '{' statements '}' ('else' '{' statements '}')?
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;ifStatement&gt;'</span><span class="p">)</span>
        <span class="c1"># (expression)
</span>        <span class="n">closing_expression_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_expression_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># {statements}
</span>        <span class="n">closing_statements_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'{'</span><span class="p">,</span> <span class="s">'}'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;statements&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileStatements</span><span class="p">(</span><span class="n">closing_expression_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/statements&gt;'</span><span class="p">)</span>
        <span class="c1"># else
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">closing_statements_idx</span> <span class="o">==</span> <span class="n">end_statements</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span> <span class="o">!=</span> <span class="s">'else'</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/ifStatement&gt;'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">closing_statements_idx</span>
        <span class="c1"># {statements}
</span>        <span class="n">closing_else_statements_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">closing_statements_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end_statements</span><span class="p">,</span> <span class="s">'{'</span><span class="p">,</span> <span class="s">'}'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_statements_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;statements&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">compileStatements</span><span class="p">(</span><span class="n">closing_statements_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">closing_else_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_else_statements_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/statements&gt;'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">closing_else_statements_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/ifStatement&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">closing_else_statements_idx</span>

    <span class="k">def</span> <span class="nf">compileExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        term (op term)*
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;expression&gt;'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end_exp</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">end_exp</span><span class="p">:</span>
            <span class="c1"># print(idx, end_exp)
</span>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileTerm</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">token</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'+'</span><span class="p">,</span> <span class="s">'-'</span><span class="p">,</span> <span class="s">'*'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">,</span> <span class="s">'&amp;'</span><span class="p">,</span> <span class="s">'|'</span><span class="p">,</span> <span class="s">'&lt;'</span><span class="p">,</span> <span class="s">'&gt;'</span><span class="p">,</span> <span class="s">'='</span><span class="p">]:</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">end_exp</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/expression&gt;'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compileTerm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">before</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;term&gt;'</span><span class="p">)</span>
        <span class="n">first_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">token</span>
        <span class="k">print</span><span class="p">(</span><span class="n">first_token</span><span class="p">)</span>
        <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">end_exp</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">end_exp</span>
        <span class="c1"># '(' expression ')'
</span>        <span class="k">if</span> <span class="n">first_token</span> <span class="o">==</span> <span class="s">'('</span><span class="p">:</span>
            <span class="n">closing_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">closing_term</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">closing_term</span>
        <span class="c1"># unaryOp
</span>        <span class="k">elif</span> <span class="n">first_token</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'-'</span><span class="p">,</span> <span class="s">'~'</span><span class="p">]:</span>
            <span class="n">closing_right_operand</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compileTerm</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">closing_right_operand</span>
        <span class="c1"># varName '[' expression ']'
</span>        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">'['</span><span class="p">:</span>
            <span class="n">closing_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">,</span> <span class="s">'['</span><span class="p">,</span> <span class="s">']'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileExpression</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">closing_term</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">closing_term</span>
        <span class="c1"># subroutineName '(' expressionList ')'
</span>        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">'('</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'subroutine'</span><span class="p">)</span>
            <span class="n">closing_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineCall</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">closing_term</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">closing_term</span>
        <span class="c1"># (className | varName) '.' subroutineName '(' expressionList ')'
</span>        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="s">'.'</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'subroutine'</span><span class="p">)</span>
            <span class="n">closing_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClosingBracket</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end_exp</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">compileSubroutineCall</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">closing_term</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">closing_term</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">[</span><span class="n">end_idx</span><span class="p">].</span><span class="n">after</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/term&gt;'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">end_idx</span>

    <span class="k">def</span> <span class="nf">saveToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">token_object</span><span class="p">.</span><span class="nb">format</span><span class="p">()</span> <span class="k">for</span> <span class="n">token_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">token_objects</span><span class="p">])</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">path_w</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">parent</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">stem</span><span class="si">}</span><span class="s">.xml'</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">p_file_list</span><span class="p">:</span> <span class="s">'list[pathlib.Path]'</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">p_path</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">p_file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p_path</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'**/*.jack'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_path</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">p_file</span> <span class="ow">in</span> <span class="n">p_file_list</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">p_file</span><span class="p">)</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">JackTokenizer</span><span class="p">(</span><span class="n">p_file</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">hasMoreLine</span><span class="p">():</span>
            <span class="n">tokenizer</span><span class="p">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">CompilationEngine</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">token_objects</span><span class="p">,</span> <span class="n">p_file</span><span class="p">)</span>
        <span class="n">compiler</span><span class="p">.</span><span class="nb">compile</span><span class="p">()</span>
        <span class="n">compiler</span><span class="p">.</span><span class="n">saveToFile</span><span class="p">()</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technology.html'>Technology</a>, <a href='/categories/low-level.html'>Low-Level</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/low-level.html" class="post-tag no-text-decoration" >Low-Level</a> <a href="/tags/compiler.html" class="post-tag no-text-decoration" >Compiler</a> <a href="/tags/jack.html" class="post-tag no-text-decoration" >Jack</a> <a href="/tags/python.html" class="post-tag no-text-decoration" >Python</a> <a href="/tags/nand2tetris.html" class="post-tag no-text-decoration" >nand2tetris</a> <a href="/tags/book-review.html" class="post-tag no-text-decoration" >Book Review</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=コンピュータシステムの理論と実装 (10) - ternbusty&url=https://ternbusty.github.io/posts/nand2tetris-10.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=コンピュータシステムの理論と実装 (10) - ternbusty&u=https://ternbusty.github.io/posts/nand2tetris-10.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=コンピュータシステムの理論と実装 (10) - ternbusty&url=https://ternbusty.github.io/posts/nand2tetris-10.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cloudflare-zero-trust.html">自宅の Raspberry Pi で立てているサービスを Cloudflare Zero Trust で公開する</a><li><a href="/posts/playlist-player.html">YouTube の再生リストをシャッフル / 逆順で再生させる</a><li><a href="/posts/gas.html">血液ガスの判定</a><li><a href="/posts/gas-diagnosis.html">酸塩基平衡障害の鑑別</a><li><a href="/posts/measure-weight.html">IoT を使って毎朝体重を測らざるを得ないようにする</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python.html">Python</a> <a class="post-tag" href="/tags/product.html">Product</a> <a class="post-tag" href="/tags/book-review.html">Book Review</a> <a class="post-tag" href="/tags/low-level.html">Low-Level</a> <a class="post-tag" href="/tags/nand2tetris.html">nand2tetris</a> <a class="post-tag" href="/tags/javascript.html">JavaScript</a> <a class="post-tag" href="/tags/jack.html">Jack</a> <a class="post-tag" href="/tags/compiler.html">Compiler</a> <a class="post-tag" href="/tags/hdl.html">HDL</a> <a class="post-tag" href="/tags/iot.html">IoT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/nand2tetris-07.html"><div class="card-body"> <em class="timeago small" date="2022-01-15 00:00:00 +0900" >Jan 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (7)</h3><div class="text-muted small"><p> 前章でアセンブリ言語からバイナリへの変換ができるようになったため、次は一段階上がってコンパイラを書いていく。本書では Jack という簡易版 Java みたいな高水準言語の処理系を実装していくことになるのだが、これはまず中間コード (VM コード) を経てアセンブリ言語に変換される形式を採っている。7 章および 8 章では、VM コードをアセンブリ言語に変換する VM translator ...</p></div></div></a></div><div class="card"> <a href="/posts/nand2tetris-08.html"><div class="card-body"> <em class="timeago small" date="2022-01-15 00:00:00 +0900" >Jan 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (8)</h3><div class="text-muted small"><p> 前章で作成した VM translator に追加して、本章ではプログラム制御 (サブルーチンの呼び出しやメモリ割り当てなど) を実装していく。 8 章 バーチャルマシン #2: プログラム制御 プログラムフローコマンド まず面倒なのが if go-to コマンドのコンパイルである。これはスタックトップの値を pop して (これは前章までの内容でいける) 0 でなければ (TRUE であ...</p></div></div></a></div><div class="card"> <a href="/posts/nand2tetris-11.html"><div class="card-body"> <em class="timeago small" date="2022-01-19 00:00:00 +0900" >Jan 19, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (11)</h3><div class="text-muted small"><p> 前章で構文解析まで終了しているので、今回はシンボルテーブルの管理とコード生成の部分を完成させていく。 11 章 コンパイラ#2: コード生成 シンボルテーブルの実装 まずは変数の管理から。本文に記載されている通り、 サブルーチンスコープ argument: サブルーチンの入力を指定する仮引数 (パラメータ変数) ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/nand2tetris-09.html" class="btn btn-outline-primary" prompt="Older"><p>コンピュータシステムの理論と実装 (9)</p></a> <a href="/posts/nand2tetris-11.html" class="btn btn-outline-primary" prompt="Newer"><p>コンピュータシステムの理論と実装 (11)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ternbusty">ternbusty</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python.html">Python</a> <a class="post-tag" href="/tags/product.html">Product</a> <a class="post-tag" href="/tags/book-review.html">Book Review</a> <a class="post-tag" href="/tags/low-level.html">Low-Level</a> <a class="post-tag" href="/tags/nand2tetris.html">nand2tetris</a> <a class="post-tag" href="/tags/javascript.html">JavaScript</a> <a class="post-tag" href="/tags/jack.html">Jack</a> <a class="post-tag" href="/tags/compiler.html">Compiler</a> <a class="post-tag" href="/tags/hdl.html">HDL</a> <a class="post-tag" href="/tags/iot.html">IoT</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']], processEscapes: true},});</script> <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS_CHTML"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PRQ5143E4V"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PRQ5143E4V'); }); </script>
