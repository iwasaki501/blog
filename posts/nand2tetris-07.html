<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="コンピュータシステムの理論と実装 (7)" /><meta property="og:locale" content="en" /><meta name="description" content="前章でアセンブリ言語からバイナリへの変換ができるようになったため、次は一段階上がってコンパイラを書いていく。本書では Jack という簡易版 Java みたいな高水準言語の処理系を実装していくことになるのだが、これはまず中間コード (VM コード) を経てアセンブリ言語に変換される形式を採っている。7 章および 8 章では、VM コードをアセンブリ言語に変換する VM translator を作成する。" /><meta property="og:description" content="前章でアセンブリ言語からバイナリへの変換ができるようになったため、次は一段階上がってコンパイラを書いていく。本書では Jack という簡易版 Java みたいな高水準言語の処理系を実装していくことになるのだが、これはまず中間コード (VM コード) を経てアセンブリ言語に変換される形式を採っている。7 章および 8 章では、VM コードをアセンブリ言語に変換する VM translator を作成する。" /><link rel="canonical" href="https://ternbusty.github.io/posts/nand2tetris-07.html" /><meta property="og:url" content="https://ternbusty.github.io/posts/nand2tetris-07.html" /><meta property="og:site_name" content="ternbusty" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-15T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="コンピュータシステムの理論と実装 (7)" /><meta name="twitter:site" content="@ternbusty" /> <script type="application/ld+json"> {"headline":"コンピュータシステムの理論と実装 (7)","dateModified":"2022-01-15T00:00:00+09:00","datePublished":"2022-01-15T00:00:00+09:00","description":"前章でアセンブリ言語からバイナリへの変換ができるようになったため、次は一段階上がってコンパイラを書いていく。本書では Jack という簡易版 Java みたいな高水準言語の処理系を実装していくことになるのだが、これはまず中間コード (VM コード) を経てアセンブリ言語に変換される形式を採っている。7 章および 8 章では、VM コードをアセンブリ言語に変換する VM translator を作成する。","url":"https://ternbusty.github.io/posts/nand2tetris-07.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ternbusty.github.io/posts/nand2tetris-07.html"},"@context":"https://schema.org"}</script><title>コンピュータシステムの理論と実装 (7) | ternbusty</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ternbusty"><meta name="application-name" content="ternbusty"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ternbusty</a></div><div class="site-subtitle font-italic">miscellaneous notes</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tools.html" class="nav-link"> <i class="fa-fw fas fa-toolbox ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives.html" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about.html" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ternbusty" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ternbusty" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ternbusty.dev','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>コンピュータシステムの理論と実装 (7)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>コンピュータシステムの理論と実装 (7)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ternbusty">ternbusty</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-01-15 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 15, 2022, 12:00 AM +0900" >Jan 15, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2443 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p>前章でアセンブリ言語からバイナリへの変換ができるようになったため、次は一段階上がってコンパイラを書いていく。本書では Jack という簡易版 Java みたいな高水準言語の処理系を実装していくことになるのだが、これはまず中間コード (VM コード) を経てアセンブリ言語に変換される形式を採っている。7 章および 8 章では、VM コードをアセンブリ言語に変換する VM translator を作成する。</p><h2 id="7-章-バーチャルマシン-1-スタック操作">7 章 バーチャルマシン #1: スタック操作<a href="#7-章-バーチャルマシン-1-スタック操作" class='anchor'><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="メモリセグメント操作">メモリセグメント操作<a href="#メモリセグメント操作" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>この章ではスタック操作を扱う。スタックポインタを <code class="language-plaintext highlighter-rouge">SP</code> とすると、例えば <code class="language-plaintext highlighter-rouge">push constant 2</code> のように、定数の 2 をスタックのトップに追加する場合は以下のように変換すればよい。<code class="language-plaintext highlighter-rouge">*(*(SP)) = 2</code> という操作をしたあとで、スタックポインタをインクリメントする形になる。</p><div class="language-hack highlighter-rouge"><div class="code-header"> <span label-text="Hack"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="mi">2</span>
<span class="nc">D</span> <span class="o">=</span> <span class="nc">A</span>
<span class="o">@</span><span class="no">SP</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">M</span>
<span class="nc">M</span> <span class="o">=</span> <span class="nc">D</span>
<span class="o">@</span><span class="no">SP</span>
<span class="nc">M</span> <span class="o">=</span> <span class="nc">M</span> <span class="o">+</span> <span class="mi">1</span>
</pre></table></code></div></div><p>この VM には <code class="language-plaintext highlighter-rouge">local</code> というセグメントがあり、関数内で定義されたローカル変数は local セグメント (ベースアドレスは <code class="language-plaintext highlighter-rouge">@LCL</code> で指定されている) でアクセスできるようになる。例えば <code class="language-plaintext highlighter-rouge">pop local 2</code> は <code class="language-plaintext highlighter-rouge">*(*(@LCL) + 2)</code> をスタックのトップにある値で更新する形になる。これをアセンブリ言語で書くと、次のような問題が発生する。</p><div class="language-hack highlighter-rouge"><div class="code-header"> <span label-text="Hack"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">// --- この前にスタックポインタをデクリメントする操作が入る ---</span>
<span class="o">@</span><span class="no">SP</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">M</span>
<span class="nc">D</span> <span class="o">=</span> <span class="nc">M</span> <span class="c1">// ここでスタックトップの値を D に格納</span>
<span class="o">@</span><span class="mi">2</span>
<span class="c1">// ここでいつも通り D = 2 としたいが、そうすると上で格納した D の値が上書きされてしまう</span>
</pre></table></code></div></div><p>最初にこの本を読んだ際はなんか適当なシンボルを新たに定義してそこを一時的な退避場所として指定していたが、<a href="https://github.com/ikenox/nand2tetris/blob/master/07/vm_translater/code_writer.py">強い人のコード</a> を見たところ <code class="language-plaintext highlighter-rouge">@2</code> とせずに以下の方法で解決していた。なるほど確かに。</p><div class="language-hack highlighter-rouge"><div class="code-header"> <span label-text="Hack"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="no">LCL</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">A</span> <span class="o">+</span> <span class="mi">1</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">A</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// 単に定数の回数だけ A をインクリメントすればよい</span>
<span class="nc">M</span> <span class="o">=</span> <span class="nc">D</span>
<span class="c1">// --- この後にスタックをデクリメントする操作が入る ---</span>
</pre></table></code></div></div><p>また、この VM では <code class="language-plaintext highlighter-rouge">pointer</code> というセグメントが用意されており、<code class="language-plaintext highlighter-rouge">pointer 0</code> は <code class="language-plaintext highlighter-rouge">this</code> を、<code class="language-plaintext highlighter-rouge">pointer 1</code> は <code class="language-plaintext highlighter-rouge">that</code> を指す。例えば <code class="language-plaintext highlighter-rouge">pop pointer 0</code> の場合だと this のベースアドレス (<code class="language-plaintext highlighter-rouge">RAM[3]</code> に格納されている値) をスタックの一番上にある値で更新することになる。ややこしいが、<code class="language-plaintext highlighter-rouge">pop that 0</code> の場合は <strong>that が指しているアドレスの値</strong> をスタックの一番上の値で更新することになるので注意。</p><p>定数でもローカル変数でもポインタでもないものは <code class="language-plaintext highlighter-rouge">static</code> で宣言することになっており、例えば <code class="language-plaintext highlighter-rouge">hoge.vm</code> にある <code class="language-plaintext highlighter-rouge">push static 3</code> は</p><div class="language-hack highlighter-rouge"><div class="code-header"> <span label-text="Hack"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">hoge</span><span class="mf">.3</span>
<span class="nc">D</span> <span class="o">=</span> <span class="nc">M</span>
<span class="c1">// 以下、D をスタックにプッシュする処理</span>
</pre></table></code></div></div><p>のように変換される。これは何か <code class="language-plaintext highlighter-rouge">static</code> というセグメントが存在してそれの 3 番目ということではなく、単に一意になるようシンボルを命名しているだけである。</p><h3 id="スタック算術">スタック算術<a href="#スタック算術" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>add, sub, and, or はいいとして問題は大小比較を行う演算子である。条件分岐を行い、true の場合はスタックトップに -1 を、false の場合は 0 を格納することになる。例えば eq の場合以下のようなコードを目指すことになる。</p><div class="language-hack highlighter-rouge"><div class="code-header"> <span label-text="Hack"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="no">SP</span>
<span class="nc">M</span> <span class="o">=</span> <span class="nc">M</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">// decrement SP</span>
<span class="o">@</span><span class="no">SP</span>
<span class="nc">D</span> <span class="o">=</span> <span class="nc">M</span> <span class="c1">// first operand</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">A</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nc">D</span> <span class="o">=</span> <span class="nc">M</span> <span class="o">-</span> <span class="nc">D</span> <span class="c1">// second - first</span>
<span class="o">@</span><span class="no">TRUE1</span>
<span class="nc">D</span><span class="p">;</span><span class="no">JEQ</span>
<span class="o">@</span><span class="no">SP</span> <span class="c1">// false </span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">M</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nc">M</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">(</span><span class="no">BACK1</span><span class="p">)</span>
<span class="mf">...</span>
<span class="p">(</span><span class="no">TRUE1</span><span class="p">)</span> <span class="c1">// true</span>
<span class="nc">A</span> <span class="o">=</span> <span class="nc">M</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nc">M</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">@</span><span class="no">BACK1</span>
<span class="mi">0</span><span class="p">;</span><span class="no">JMP</span>
</pre></table></code></div></div><p>2 項演算子ならスタックポインタをデクリメントする必要があるが、neg や not ではその必要がないので注意。</p><h3 id="完成したコード">完成したコード<a href="#完成したコード" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>以上まとめると次のようになる。</p><div file="VMtranslator.py" class="language-python highlighter-rouge"><div class="code-header"> <span label-text="VMtranslator.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">CodeWriter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'local'</span><span class="p">:</span> <span class="s">'@LCL'</span><span class="p">,</span>
            <span class="s">'argument'</span><span class="p">:</span> <span class="s">'@ARG'</span><span class="p">,</span>
            <span class="s">'this'</span><span class="p">:</span> <span class="s">'@THIS'</span><span class="p">,</span>
            <span class="s">'that'</span><span class="p">:</span> <span class="s">'@THAT'</span><span class="p">,</span>
            <span class="s">'pointer'</span><span class="p">:</span> <span class="s">'@3'</span><span class="p">,</span>
            <span class="s">'temp'</span><span class="p">:</span> <span class="s">'@5'</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'increment_sp'</span><span class="p">:</span> <span class="p">[</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'M = M + 1'</span><span class="p">],</span>
            <span class="s">'decrement_sp'</span><span class="p">:</span> <span class="p">[</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'M = M - 1'</span><span class="p">],</span>
            <span class="s">'copy_d_to_stack_top'</span><span class="p">:</span> <span class="p">[</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'A = M'</span><span class="p">,</span> <span class="s">'M = D'</span><span class="p">],</span>
            <span class="s">'from_stack_top_value_to_d'</span><span class="p">:</span> <span class="p">[</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'A = M'</span><span class="p">,</span> <span class="s">'D = M'</span><span class="p">],</span>
            <span class="s">'update_address_to_top'</span><span class="p">:</span> <span class="p">[</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'A = M'</span><span class="p">],</span>
            <span class="s">'move_address_backward'</span><span class="p">:</span> <span class="p">[</span><span class="s">'A = A - 1'</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">appendix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">setFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">stem</span>  <span class="c1"># get filename
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">path_w</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span><span class="p">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s">'.asm'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">processPush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'constant'</span><span class="p">:</span>
            <span class="c1"># Place num to stack top. ex) 'push constant 2'
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'D = A'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'static'</span><span class="p">:</span>
            <span class="c1"># Place the value of a symbol to stack top. ex) 'push static 1'
</span>            <span class="c1"># Create the name of the symbol. ex) '@filename.1'
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'D = M'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'pointer'</span> <span class="ow">or</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'temp'</span><span class="p">:</span>
            <span class="c1"># Place the address of this (pointer[0]) or that (pointer[1]) to stack top. ex) 'push pointer 1', or
</span>            <span class="c1"># Place the value of temp to stack top. ex) 'push temp 1'
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'D = A'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">dic</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'A = A + D'</span><span class="p">,</span> <span class="s">'D = M'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># argument, local, this, that
</span>            <span class="c1"># Place the value of the specified segment[idx] to stack top. ex) 'push argument 3'
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'D = A'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">dic</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'A = M + D'</span><span class="p">,</span> <span class="s">'D = M'</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'copy_d_to_stack_top'</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'increment_sp'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">processPop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'decrement_sp'</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'from_stack_top_value_to_d'</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'constant'</span><span class="p">:</span>
            <span class="c1"># Remove num from stack top. ex) 'pop constant 2'
</span>            <span class="c1"># Is 'pop constant' possible in .vm file?
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'M = D'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'static'</span><span class="p">:</span>
            <span class="c1"># Place the value of a stack top to a symbol. ex) 'pop static 1'
</span>            <span class="c1"># Create the name of the symbol. ex) '@filename.1'
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'@</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'M = D'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">forward_A_arg2_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'A = A + 1'</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">arg2</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'pointer'</span> <span class="ow">or</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s">'temp'</span><span class="p">:</span>
                <span class="c1"># Place the value of the stack top to this (pointer[0]) or that (pointer[1]). ex) 'pop pointer 1', or
</span>                <span class="c1"># Place the value of the stack top to temp. ex) 'pop temp 1'
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">dic</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">]</span> <span class="o">+</span> <span class="n">forward_A_arg2_times</span> <span class="o">+</span> <span class="p">[</span><span class="s">'M = D'</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># argument, local, this, that
</span>                <span class="c1"># Place the value of the stack top to specified segment[idx]. ex) 'pop argument 3'
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">dic</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'A = M'</span><span class="p">]</span> <span class="o">+</span> <span class="n">forward_A_arg2_times</span> <span class="o">+</span> <span class="p">[</span><span class="s">'M = D'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">processArithmetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'neg'</span> <span class="ow">or</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'not'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'update_address_to_top'</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'move_address_backward'</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'M = -M'</span><span class="p">]</span> <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'neg'</span> <span class="k">else</span> <span class="p">[</span><span class="s">'M = !M'</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'decrement_sp'</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'from_stack_top_value_to_d'</span><span class="p">]</span>  <span class="c1"># set the value of the second operand to D
</span>            <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="s">'move_address_backward'</span><span class="p">])</span>  <span class="c1"># move address to the first operand
</span>        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'add'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'M = M + D'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'sub'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'M = M - D'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'and'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'M = D &amp; M'</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'or'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'M = D | M'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># eq, gt, lt
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'D = M - D'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'@TRUE</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span><span class="si">}</span><span class="s">'</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'eq'</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'D;JEQ'</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'gt'</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'D;JGT'</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'lt'</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'D;JLT'</span><span class="p">])</span>
            <span class="c1"># If false, write 0 (false) to the top of the stuck
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addOutputLines</span><span class="p">([</span><span class="s">'@SP'</span><span class="p">,</span> <span class="s">'A = M - 1'</span><span class="p">,</span> <span class="s">'M = 0'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'(BACK</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span><span class="p">)</span><span class="si">}</span><span class="s">)'</span><span class="p">])</span>
            <span class="c1"># If true, write -1 (true) to the top of the stuck
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">addAppendixLines</span><span class="p">([</span><span class="sa">f</span><span class="s">'(TRUE</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span> <span class="s">'@SP'</span><span class="p">,</span> <span class="s">'A = M - 1'</span><span class="p">,</span>
                                   <span class="s">'M = -1'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'@BACK</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'0;JMP'</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">appendix_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">addOutputLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="s">'list[str]'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>

    <span class="k">def</span> <span class="nf">addAppendixLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="s">'list[str]'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">appendix</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>

    <span class="k">def</span> <span class="nf">saveToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">appendix</span> <span class="o">!=</span> <span class="s">''</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">output</span> <span class="o">+=</span> <span class="s">'@END</span><span class="se">\n</span><span class="s">0;JMP</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">appendix</span> <span class="o">+</span> <span class="s">'(END)</span><span class="se">\n</span><span class="s">'</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Parser</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">p_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">'//.*\n'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># delete comments
</span>        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">' *\n'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># delete spaces at the end of lines
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">lines</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s">''</span><span class="p">]</span>  <span class="c1"># delete black lines
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">line_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">commandType</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        Determine command type from a line
        """</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'push'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_PUSH'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'pop'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_POP'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'label'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_label'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'goto'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_GOTO'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'if-goto'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_IF'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'function'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_FUNCTION'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'return'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_RETURN'</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">'call'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_CALL'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'C_ARITHMETIC'</span>

    <span class="k">def</span> <span class="nf">arg1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        Returns the first argument
        """</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># ex) 'local' in 'push local 0'
</span>            <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># When C_ARITHMETIC, the command itself is returned. ex) 'add'
</span>            <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">arg2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        Returns the second argument.
        This is called only when 'C_PUSH', 'C_POP', 'C_FUNCTION', or 'C_CALL'
        """</span>
        <span class="c1"># ex) '0' in 'push local 0'
</span>        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">hasMoreCommands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">line_num</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">current_line_num</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">CodeWriter</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">parser</span><span class="p">.</span><span class="n">hasMoreCommands</span><span class="p">():</span>
        <span class="n">parser</span><span class="p">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="n">command_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">commandType</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">command_type</span> <span class="o">==</span> <span class="s">'C_ARITHMETIC'</span><span class="p">:</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">processArithmetric</span><span class="p">(</span><span class="n">parser</span><span class="p">.</span><span class="n">arg1</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="o">==</span> <span class="s">'C_PUSH'</span><span class="p">:</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">processPush</span><span class="p">(</span><span class="n">parser</span><span class="p">.</span><span class="n">arg1</span><span class="p">(),</span> <span class="n">parser</span><span class="p">.</span><span class="n">arg2</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="o">==</span> <span class="s">'C_POP'</span><span class="p">:</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">processPop</span><span class="p">(</span><span class="n">parser</span><span class="p">.</span><span class="n">arg1</span><span class="p">(),</span> <span class="n">parser</span><span class="p">.</span><span class="n">arg2</span><span class="p">())</span>

    <span class="n">writer</span><span class="p">.</span><span class="n">saveToFile</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="感想">感想<a href="#感想" class='anchor'><i class="fas fa-hashtag"></i></a></h3></h3><p>大昔 C 言語をかじったときはポインタのポインタとか具体的に何の役に立つのか全然分からなかったけど、こうして処理系を頑張って自作してみると必要性が実感できてよい。低レイヤは楽しいね。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technology.html'>Technology</a>, <a href='/categories/low-level.html'>Low-Level</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/low-level.html" class="post-tag no-text-decoration" >Low-Level</a> <a href="/tags/compiler.html" class="post-tag no-text-decoration" >Compiler</a> <a href="/tags/jack.html" class="post-tag no-text-decoration" >Jack</a> <a href="/tags/python.html" class="post-tag no-text-decoration" >Python</a> <a href="/tags/nand2tetris.html" class="post-tag no-text-decoration" >nand2tetris</a> <a href="/tags/book-review.html" class="post-tag no-text-decoration" >Book Review</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=コンピュータシステムの理論と実装 (7) - ternbusty&url=https://ternbusty.github.io/posts/nand2tetris-07.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=コンピュータシステムの理論と実装 (7) - ternbusty&u=https://ternbusty.github.io/posts/nand2tetris-07.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=コンピュータシステムの理論と実装 (7) - ternbusty&url=https://ternbusty.github.io/posts/nand2tetris-07.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cloudflare-zero-trust.html">自宅の Raspberry Pi で立てているサービスを Cloudflare Zero Trust で公開する</a><li><a href="/posts/playlist-player.html">YouTube の再生リストをシャッフル / 逆順で再生させる</a><li><a href="/posts/gas.html">血液ガスの判定</a><li><a href="/posts/gas-diagnosis.html">酸塩基平衡障害の鑑別</a><li><a href="/posts/measure-weight.html">IoT を使って毎朝体重を測らざるを得ないようにする</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python.html">Python</a> <a class="post-tag" href="/tags/product.html">Product</a> <a class="post-tag" href="/tags/book-review.html">Book Review</a> <a class="post-tag" href="/tags/low-level.html">Low-Level</a> <a class="post-tag" href="/tags/nand2tetris.html">nand2tetris</a> <a class="post-tag" href="/tags/javascript.html">JavaScript</a> <a class="post-tag" href="/tags/jack.html">Jack</a> <a class="post-tag" href="/tags/compiler.html">Compiler</a> <a class="post-tag" href="/tags/hdl.html">HDL</a> <a class="post-tag" href="/tags/iot.html">IoT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/nand2tetris-08.html"><div class="card-body"> <em class="timeago small" date="2022-01-15 00:00:00 +0900" >Jan 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (8)</h3><div class="text-muted small"><p> 前章で作成した VM translator に追加して、本章ではプログラム制御 (サブルーチンの呼び出しやメモリ割り当てなど) を実装していく。 8 章 バーチャルマシン #2: プログラム制御 プログラムフローコマンド まず面倒なのが if go-to コマンドのコンパイルである。これはスタックトップの値を pop して (これは前章までの内容でいける) 0 でなければ (TRUE であ...</p></div></div></a></div><div class="card"> <a href="/posts/nand2tetris-10.html"><div class="card-body"> <em class="timeago small" date="2022-01-15 00:00:00 +0900" >Jan 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (10)</h3><div class="text-muted small"><p> 前章までで中間コードをアセンブリに変換する部分は完成したので、本章からは後半部分である Jack 言語から中間コードへのコンパイラを書いていく。 10 章 コンパイラ#1: 構文解析 tokenizer を書く コードを token ごとに区切り、xml として出力するコードを書けばよい。こんなん半角スペースで分割してそれぞれの要素が何であるかを判定していけばいいだけやんとか思っていたが、...</p></div></div></a></div><div class="card"> <a href="/posts/nand2tetris-11.html"><div class="card-body"> <em class="timeago small" date="2022-01-19 00:00:00 +0900" >Jan 19, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>コンピュータシステムの理論と実装 (11)</h3><div class="text-muted small"><p> 前章で構文解析まで終了しているので、今回はシンボルテーブルの管理とコード生成の部分を完成させていく。 11 章 コンパイラ#2: コード生成 シンボルテーブルの実装 まずは変数の管理から。本文に記載されている通り、 サブルーチンスコープ argument: サブルーチンの入力を指定する仮引数 (パラメータ変数) ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/competitive-programming-environment.html" class="btn btn-outline-primary" prompt="Older"><p>競プロ用環境構築のメモ</p></a> <a href="/posts/nand2tetris-08.html" class="btn btn-outline-primary" prompt="Newer"><p>コンピュータシステムの理論と実装 (8)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ternbusty">ternbusty</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python.html">Python</a> <a class="post-tag" href="/tags/product.html">Product</a> <a class="post-tag" href="/tags/book-review.html">Book Review</a> <a class="post-tag" href="/tags/low-level.html">Low-Level</a> <a class="post-tag" href="/tags/nand2tetris.html">nand2tetris</a> <a class="post-tag" href="/tags/javascript.html">JavaScript</a> <a class="post-tag" href="/tags/jack.html">Jack</a> <a class="post-tag" href="/tags/compiler.html">Compiler</a> <a class="post-tag" href="/tags/hdl.html">HDL</a> <a class="post-tag" href="/tags/iot.html">IoT</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']], processEscapes: true},});</script> <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS_CHTML"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PRQ5143E4V"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PRQ5143E4V'); }); </script>
